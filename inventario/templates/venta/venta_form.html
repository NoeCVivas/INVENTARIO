{% extends 'base.html' %}

{% block title %}Registrar Venta{% endblock %}
{% block header %}<i class="fas fa-receipt"></i> Registrar Nueva Venta{% endblock %}

{% block extra_buttons %}
<div class="d-flex gap-2">
  <a href="{% url 'home' %}" class="btn btn-outline-secondary">
    <i class="fas fa-home"></i> Menú Inicial
  </a>
</div>
{% endblock %}

{% block content %}
<form method="post">
  {% csrf_token %}
  <div class="card mb-4">
    <div class="card-body" style="background-color: #F8F6F3;">
      {{ form.as_p }}
    </div>
  </div>

  {{ formset.management_form }}

  <table class="table table-bordered table-hover" id="tabla-items" style="background-color: #fff;">
    <thead style="background-color: #4B1E1E; color: #F8F6F3;">
      <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Subtotal</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody>
      {% for form in formset %}
      <tr class="item-venta">
        <td>{{ form.producto }}</td>
        <td>{{ form.cantidad }}</td>
        <td>{{ form.precio_unitario }}</td>
        <td class="subtotal">$0.00</td>
        <td><button type="button" class="btn btn-sm btn-outline-danger eliminar-fila">✖</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <button type="button" class="btn btn-outline-success" id="agregar-fila">
      <i class="fas fa-plus-circle"></i> Agregar producto
    </button>
    <div>
      <strong>Total:</strong> <span id="total-venta">$0.00</span> |
      <strong>Ítems:</strong> <span id="cantidad-items">0</span>
    </div>
  </div>

  <button type="submit" class="btn btn-vinoteca w-100">
    <i class="fas fa-check-circle"></i> Registrar venta
  </button>
</form>

<script>
  const precios = {{ precios_json|default:"{}"|safe }};
  const stocks = {{ stocks_json|default:"{}"|safe }};

  function actualizarTotales() {
    let total = 0;
    let cantidadItems = 0;

    document.querySelectorAll('.item-venta').forEach(fila => {
      const cantidadInput = fila.querySelector('.cantidad');
      const precioInput = fila.querySelector('.precio-unitario');
      const subtotalField = fila.querySelector('.subtotal');

      const cantidad = parseFloat(cantidadInput?.value || 0);
      const precio = parseFloat(precioInput?.value || 0);
      const subtotal = cantidad * precio;

      if (subtotalField) {
        subtotalField.textContent = `$${subtotal.toFixed(2)}`;
      }

      total += subtotal;
      if (cantidad > 0) cantidadItems += 1;
    });

    document.getElementById('total-venta').textContent = `$${total.toFixed(2)}`;
    document.getElementById('cantidad-items').textContent = cantidadItems;
  }

  function inicializarEventosFila(fila) {
    const productoSelect = fila.querySelector('.producto');
    const cantidadInput = fila.querySelector('.cantidad');
    const precioInput = fila.querySelector('.precio-unitario');

    if (productoSelect) {
      productoSelect.addEventListener('change', function () {
        const productoId = this.value;
        const precio = precios[productoId];
        const stock = stocks[productoId];

        if (precio !== undefined) {
          precioInput.value = precio.toFixed(2);
        } else {
          precioInput.value = '';
          alert("⚠️ Este producto no tiene precio definido.");
        }

        if (stock !== undefined) {
          cantidadInput.max = stock;
        } else {
          cantidadInput.max = 0;
          alert("⚠️ Este producto no tiene stock disponible.");
        }

        actualizarTotales();
      });
    }

    if (cantidadInput) {
      cantidadInput.addEventListener('input', actualizarTotales);
    }

    const eliminarBtn = fila.querySelector('.eliminar-fila');
    if (eliminarBtn) {
      eliminarBtn.addEventListener('click', function () {
        fila.remove();
        actualizarTotales();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.item-venta').forEach(inicializarEventosFila);
    actualizarTotales();

    document.getElementById('agregar-fila').addEventListener('click', function () {
      const tabla = document.getElementById('tabla-items').querySelector('tbody');
      const ultimaFila = tabla.querySelector('.item-venta:last-child');
      const nuevaFila = ultimaFila.cloneNode(true);

      nuevaFila.querySelector('.producto').selectedIndex = 0;
      nuevaFila.querySelector('.cantidad').value = '';
      nuevaFila.querySelector('.precio-unitario').value = '';
      nuevaFila.querySelector('.subtotal').textContent = '$0.00';

      tabla.appendChild(nuevaFila);
      inicializarEventosFila(nuevaFila);
    });
  });
</script>
{% endblock %}
