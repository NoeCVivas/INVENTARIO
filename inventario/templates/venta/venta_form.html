{% extends 'base.html' %}
{% load static %}

{% block title %}Registrar Venta{% endblock %}
{% block header %}<i class="fas fa-receipt"></i> Registrar Nueva Venta{% endblock %}
{% block extra_buttons %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-center">
  <div class="card shadow-sm mb-4" style="width: 100%; max-width: 1000px; background-color: #F8F6F3;">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}

        <!-- Medio de pago y cliente -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="id_medio_pago"><i class="fas fa-credit-card"></i> Medio de pago</label>
            {{ form.medio_pago }}
          </div>
          <div class="col-md-6">
            <label for="id_cliente"><i class="fas fa-user"></i> Cliente</label>
            {{ form.cliente }}
          </div>
        </div>

        <!-- Fecha -->
        <div class="row mb-4">
          <div class="col-md-4">
            <label for="id_fecha"><i class="fas fa-calendar-alt"></i> Fecha</label>
            {{ form.fecha }}
          </div>
        </div>

        <!-- Campos de tarjeta -->
        <div id="datos-tarjeta" style="display: none;" class="mt-4">
          <div class="row">
            <div class="col-md-4">
              <label for="numero_tarjeta"><i class="fas fa-credit-card-front"></i> N√∫mero de tarjeta</label>
              <input type="text" class="form-control" id="numero_tarjeta" name="numero_tarjeta"
                     pattern="\d{16}" maxlength="16" placeholder="XXXXXXXXXXXXXXXX"
                     title="Ingres√° los 16 d√≠gitos sin espacios">
            </div>
            <div class="col-md-4">
              <label for="codigo_seguridad"><i class="fas fa-lock"></i> CVV</label>
              <input type="text" class="form-control" id="codigo_seguridad" name="codigo_seguridad"
                     pattern="\d{3,4}" maxlength="4" placeholder="CVV"
                     title="Ingres√° 3 o 4 d√≠gitos">
            </div>
            <div class="col-md-4">
              <label for="fecha_vencimiento"><i class="fas fa-calendar"></i> Vencimiento</label>
              <input type="month" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento">
            </div>
          </div>
        </div>

        <!-- Imagen QR -->
        <div id="qr-pago" style="display: none;" class="mt-4 text-center">
          <img src="{% static 'img/qr_pago.png' %}" alt="C√≥digo QR para pago" style="max-width: 200px;">
          <p class="mt-2">Escane√° el c√≥digo para completar el pago.</p>
        </div>

        {{ formset.management_form }}

        <!-- TEMPLATE OCULTO -->
        <template id="fila-template">
          <tr class="item-venta">
            <td>{{ formset.empty_form.producto }}</td>
            <td>{{ formset.empty_form.cantidad }}</td>
            <td>{{ formset.empty_form.precio_unitario }}</td>
            <td>{{ formset.empty_form.subtotal }}</td>
            <td>
              {{ formset.empty_form.DELETE }}
              <button type="button" class="btn btn-sm btn-outline-danger eliminar-fila">‚úñ</button>
            </td>
            {% for hidden in formset.empty_form.hidden_fields %}
              {{ hidden }}
            {% endfor %}
          </tr>
        </template>

        <!-- TABLA -->
        <div class="table-responsive mt-4">
          <table class="table table-bordered table-hover" id="tabla-items" style="background-color: #fff;">
            <thead style="background-color: #4B1E1E; color: #F8F6F3;">
              <tr>
                <th style="width: 35%;">Producto</th>
                <th style="width: 15%;">Cantidad</th>
                <th style="width: 20%;">Precio Unitario</th>
                <th style="width: 20%;">Subtotal</th>
                <th style="width: 10%;">Eliminar</th>
              </tr>
            </thead>
            <tbody>
              {% for form in formset %}
              <tr class="item-venta">
                <td>{{ form.producto }}</td>
                <td>{{ form.cantidad }}</td>
                <td>{{ form.precio_unitario }}</td>
                <td>{{ form.subtotal }}</td>
                <td>
                  {{ form.DELETE }}
                  <button type="button" class="btn btn-sm btn-outline-danger eliminar-fila">‚úñ</button>
                </td>
                {% for hidden in form.hidden_fields %}
                  {{ hidden }}
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <button type="button" class="btn btn-outline-success" id="agregar-fila">
            <i class="fas fa-plus-circle"></i> Agregar producto
          </button>
          <div>
            <strong>Total:</strong> <span id="total-venta">$0.00</span> |
            <strong>√çtems:</strong> <span id="cantidad-items">0</span>
          </div>
        </div>

        <button type="submit" class="btn btn-vinoteca w-100">
          <i class="fas fa-check-circle"></i> Registrar venta
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const precios = {{ precios_json|default:"{}"|safe }};
  const stocks = {{ stocks_json|default:"{}"|safe }};
  const totalFormsInput = document.querySelector('input[name="form-TOTAL_FORMS"]');
  const template = document.getElementById('fila-template');

  function actualizarTotales() {
    let total = 0;
    let cantidadItems = 0;

    document.querySelectorAll('.item-venta').forEach(fila => {
      const cantidadInput = fila.querySelector('.cantidad');
      const precioInput = fila.querySelector('.precio-unitario');
      const subtotalField = fila.querySelector('.subtotal');

      const cantidad = parseFloat(cantidadInput?.value || 0);
      const precio = parseFloat(precioInput?.value || 0);
      const subtotal = cantidad * precio;

      if (subtotalField) subtotalField.value = subtotal.toFixed(2);
      total += subtotal;
      if (cantidad > 0) cantidadItems++;
    });

    document.getElementById('total-venta').textContent = `$${total.toFixed(2)}`;
    document.getElementById('cantidad-items').textContent = cantidadItems;
  }

  function inicializarEventosFila(fila) {
    const productoSelect = fila.querySelector('.producto');
    const cantidadInput = fila.querySelector('.cantidad');
    const precioInput = fila.querySelector('.precio-unitario');

    if (productoSelect) {
      productoSelect.addEventListener('change', function () {
        const id = this.value;
        const precio = precios[id];
        const stock = stocks[id];

        precioInput.value = precio ? Number(precio).toFixed(2) : '';

        cantidadInput.max = stock ?? 0;

        actualizarTotales();
      });
    }

    if (cantidadInput) {
      cantidadInput.addEventListener('input', actualizarTotales);
    }

    const eliminarBtn = fila.querySelector('.eliminar-fila');
    eliminarBtn.addEventListener('click', () => {
      const deleteCheckbox = fila.querySelector('input[type="checkbox"]');
      if (deleteCheckbox) deleteCheckbox.checked = true;
      fila.style.display = 'none';
      actualizarTotales();
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.item-venta').forEach(inicializarEventosFila);
    actualizarTotales();

    const tbody = document.querySelector('#tabla-items tbody');
    const agregarBtn = document.getElementById('agregar-fila');

    agregarBtn.addEventListener('click', function () {

      // üîß FIX PRINCIPAL: CLONAR CORRECTAMENTE EL TEMPLATE COMPLETO
      const newIndex = parseInt(totalFormsInput.value, 10);

      const nuevaFila = template.content.cloneNode(true).firstElementChild;

      // Actualizar __prefix__ -> newIndex
      nuevaFila.innerHTML = nuevaFila.innerHTML.replace(/__prefix__/g, newIndex);

      tbody.appendChild(nuevaFila);
      inicializarEventosFila(nuevaFila);

      totalFormsInput.value = newIndex + 1;
      actualizarTotales();
    });

    const medioPago = document.getElementById('id_medio_pago');
    const datosTarjeta = document.getElementById('datos-tarjeta');
    const qrPago = document.getElementById('qr-pago');

    function toggleMedioPago() {
      const valor = (medioPago.value || '').toLowerCase();
      datosTarjeta.style.display = 'none';
      qrPago.style.display = 'none';

      if (valor === 'credito' || valor === 'debito') {
        datosTarjeta.style.display = 'block';
      } else if (valor === 'qr') {
        qrPago.style.display = 'block';
      }
    }

    medioPago.addEventListener('change', toggleMedioPago);
    toggleMedioPago();
  });
</script>

{% endblock %}
