{% extends 'base.html' %}
{% load static %}

{% block title %}Registrar Venta{% endblock %}
{% block header %}<i class="fas fa-receipt"></i> Registrar Nueva Venta{% endblock %}

{% block extra_buttons %}
<div class="d-flex gap-2">
  <a href="{% url 'home' %}" class="btn btn-outline-secondary">
    <i class="fas fa-home"></i> Menú Inicial
  </a>
</div>
{% endblock %}

{% block content %}
<form method="post">
  {% csrf_token %}
  <div class="card mb-4">
    <div class="card-body" style="background-color: #F8F6F3;">
      <!-- Medio de pago -->
      <div class="form-group">
        <label for="id_medio_pago">Medio de pago</label>
        {{ form.medio_pago }}
      </div>

      <!-- Resto del formulario -->
      {% for field in form %}
        {% if field.name != 'medio_pago' %}
          <div class="form-group">
            {{ field.label_tag }} {{ field }}
            {% if field.errors %}
              <div class="text-danger">{{ field.errors }}</div>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Campos de tarjeta -->
      <div id="datos-tarjeta" style="display: none;" class="mt-4">
        <div class="form-group">
          <label for="numero_tarjeta">Número de tarjeta</label>
          <input type="text" class="form-control" id="numero_tarjeta" name="numero_tarjeta"
                 pattern="\d{16}" maxlength="16" placeholder="XXXXXXXXXXXXXXXX"
                 title="Ingresá los 16 dígitos sin espacios">
        </div>
        <div class="form-group">
          <label for="fecha_vencimiento">Fecha de vencimiento</label>
          <input type="month" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento">
        </div>
        <div class="form-group">
          <label for="codigo_seguridad">Código de seguridad (CVV)</label>
          <input type="text" class="form-control" id="codigo_seguridad" name="codigo_seguridad"
                 pattern="\d{3,4}" maxlength="4" placeholder="CVV"
                 title="Ingresá 3 o 4 dígitos">
        </div>
      </div>

      <!-- Imagen QR -->
      <div id="qr-pago" style="display: none;" class="mt-4 text-center">
        <img src="{% static 'img/qr_pago.png' %}" alt="Código QR para pago" style="max-width: 200px;">
        <p class="mt-2">Escaneá el código para completar el pago.</p>
      </div>
    </div>
  </div>

  {{ formset.management_form }}

  <table class="table table-bordered table-hover" id="tabla-items" style="background-color: #fff;">
    <thead style="background-color: #4B1E1E; color: #F8F6F3;">
      <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Subtotal</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody>
      {% for form in formset %}
      <tr class="item-venta">
        <td>{{ form.producto }}</td>
        <td>{{ form.cantidad }}</td>
        <td>{{ form.precio_unitario }}</td>
        <td class="subtotal">$0.00</td>
        <td><button type="button" class="btn btn-sm btn-outline-danger eliminar-fila">✖</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <button type="button" class="btn btn-outline-success" id="agregar-fila">
      <i class="fas fa-plus-circle"></i> Agregar producto
    </button>
    <div>
      <strong>Total:</strong> <span id="total-venta">$0.00</span> |
      <strong>Ítems:</strong> <span id="cantidad-items">0</span>
    </div>
  </div>

  <button type="submit" class="btn btn-vinoteca w-100">
    <i class="fas fa-check-circle"></i> Registrar venta
  </button>
</form>

<script>
  const precios = {{ precios_json|default:"{}"|safe }};
  const stocks = {{ stocks_json|default:"{}"|safe }};

  function actualizarTotales() {
    let total = 0;
    let cantidadItems = 0;

    document.querySelectorAll('.item-venta').forEach(fila => {
      const cantidadInput = fila.querySelector('.cantidad');
      const precioInput = fila.querySelector('.precio-unitario');
      const subtotalField = fila.querySelector('.subtotal');

      const cantidad = parseFloat(cantidadInput?.value || 0);
      const precio = parseFloat(precioInput?.value || 0);
      const subtotal = cantidad * precio;

      if (subtotalField) {
        subtotalField.textContent = `$${subtotal.toFixed(2)}`;
      }

      total += subtotal;
      if (cantidad > 0) cantidadItems += 1;
    });

    document.getElementById('total-venta').textContent = `$${total.toFixed(2)}`;
    document.getElementById('cantidad-items').textContent = cantidadItems;
  }

  function inicializarEventosFila(fila) {
    const productoSelect = fila.querySelector('.producto');
    const cantidadInput = fila.querySelector('.cantidad');
    const precioInput = fila.querySelector('.precio-unitario');

    if (productoSelect) {
      productoSelect.addEventListener('change', function () {
        const productoId = this.value;
        const precio = precios[productoId];
        const stock = stocks[productoId];

        if (precio !== undefined) {
          precioInput.value = precio.toFixed(2);
        } else {
          precioInput.value = '';
          alert("⚠️ Este producto no tiene precio definido.");
        }

        if (stock !== undefined) {
          cantidadInput.max = stock;
        } else {
          cantidadInput.max = 0;
          alert("⚠️ Este producto no tiene stock disponible.");
        }

        actualizarTotales();
      });
    }

    if (cantidadInput) {
      cantidadInput.addEventListener('input', actualizarTotales);
    }

    const eliminarBtn = fila.querySelector('.eliminar-fila');
    if (eliminarBtn) {
      eliminarBtn.addEventListener('click', function () {
        fila.remove();
        actualizarTotales();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.item-venta').forEach(inicializarEventosFila);
    actualizarTotales();

    document.getElementById('agregar-fila').addEventListener('click', function () {
      const tabla = document.getElementById('tabla-items').querySelector('tbody');
      const ultimaFila = tabla.querySelector('.item-venta:last-child');
      const nuevaFila = ultimaFila.cloneNode(true);

      nuevaFila.querySelector('.producto').selectedIndex = 0;
      nuevaFila.querySelector('.cantidad').value = '';
      nuevaFila.querySelector('.precio-unitario').value = '';
      nuevaFila.querySelector('.subtotal').textContent = '$0.00';

      tabla.appendChild(nuevaFila);
      inicializarEventosFila(nuevaFila);
    });

    // Mostrar campos de tarjeta o QR según medio de pago
    const medioPago = document.getElementById('id_medio_pago');
    const datosTarjeta = document.getElementById('datos-tarjeta');
    const qrPago = document.getElementById('qr-pago');

    function toggleMedioPago() {
      const valor = medioPago.value.toLowerCase();
      datosTarjeta.style.display = 'none';
      qrPago.style.display = 'none';

      if (valor === 'credito' || valor === 'debito') {
        datosTarjeta.style.display = 'block';
      } else if (valor === 'qr') {
        qrPago.style.display = 'block';
      }
    }

    if (medioPago) {
      medioPago.addEventListener('change', toggleMedioPago);
      toggleMedioPago(); // Ejecutar al cargar
    }
  });
</script>
{% endblock %}
