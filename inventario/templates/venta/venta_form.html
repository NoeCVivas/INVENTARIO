{% extends 'base.html' %}
{% load static %}

{% block title %}Registrar Venta{% endblock %}
{% block header %}<i class="fas fa-receipt"></i> Registrar Nueva Venta{% endblock %}

{% block extra_buttons %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-center">
  <div class="card shadow-sm mb-4" style="width: 100%; max-width: 900px; background-color: #F8F6F3;">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}

        <!-- Medio de pago y cliente -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="id_medio_pago"><i class="fas fa-credit-card"></i> Medio de pago</label>
            {{ form.medio_pago }}
          </div>
          <div class="col-md-6">
            <label for="id_cliente"><i class="fas fa-user"></i> Cliente</label>
            {{ form.cliente }}
          </div>
        </div>

        <!-- Fecha separada -->
        <div class="row mb-4">
          <div class="col-md-4">
            <label for="id_fecha"><i class="fas fa-calendar-alt"></i> Fecha</label>
            {{ form.fecha }}
          </div>
        </div>

        <!-- Campos de tarjeta alineados -->
        <div id="datos-tarjeta" style="display: none;" class="mt-4">
          <div class="row">
            <div class="col-md-4">
              <label for="numero_tarjeta"><i class="fas fa-credit-card-front"></i> Número de tarjeta</label>
              <input type="text" class="form-control" id="numero_tarjeta" name="numero_tarjeta"
                     pattern="\d{16}" maxlength="16" placeholder="XXXXXXXXXXXXXXXX"
                     title="Ingresá los 16 dígitos sin espacios">
            </div>
            <div class="col-md-4">
              <label for="codigo_seguridad"><i class="fas fa-lock"></i> CVV</label>
              <input type="text" class="form-control" id="codigo_seguridad" name="codigo_seguridad"
                     pattern="\d{3,4}" maxlength="4" placeholder="CVV"
                     title="Ingresá 3 o 4 dígitos">
            </div>
            <div class="col-md-4">
              <label for="fecha_vencimiento"><i class="fas fa-calendar"></i> Vencimiento</label>
              <input type="month" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento">
            </div>
          </div>
        </div>

        <!-- Imagen QR -->
        <div id="qr-pago" style="display: none;" class="mt-4 text-center">
          <img src="{% static 'img/qr_pago.png' %}" alt="Código QR para pago" style="max-width: 200px;">
          <p class="mt-2">Escaneá el código para completar el pago.</p>
        </div>

        {{ formset.management_form }}

        <div class="table-responsive mt-4">
          <table class="table table-bordered table-hover" id="tabla-items" style="background-color: #fff;">
            <thead style="background-color: #4B1E1E; color: #F8F6F3;">
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th>Eliminar</th>
              </tr>
            </thead>
            <tbody>
              {% for form in formset %}
              <tr class="item-venta">
                <td>{{ form.producto }}</td>
                <td>{{ form.cantidad }}</td>
                <td>{{ form.precio_unitario }}</td>
                <td class="subtotal">$0.00</td>
                <td><button type="button" class="btn btn-sm btn-outline-danger eliminar-fila">✖</button></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <button type="button" class="btn btn-outline-success" id="agregar-fila">
            <i class="fas fa-plus-circle"></i> Agregar producto
          </button>
          <div>
            <strong>Total:</strong> <span id="total-venta">$0.00</span> |
            <strong>Ítems:</strong> <span id="cantidad-items">0</span>
          </div>
        </div>

        <button type="submit" class="btn btn-vinoteca w-100">
          <i class="fas fa-check-circle"></i> Registrar venta
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const precios = {{ precios_json|default:"{}"|safe }};
  const stocks = {{ stocks_json|default:"{}"|safe }};

  function actualizarTotales() {
    let total = 0;
    let cantidadItems = 0;

    document.querySelectorAll('.item-venta').forEach(fila => {
      const cantidadInput = fila.querySelector('.cantidad');
      const precioInput = fila.querySelector('.precio-unitario');
      const subtotalField = fila.querySelector('.subtotal');

      const cantidad = parseFloat(cantidadInput?.value || 0);
      const precio = parseFloat(precioInput?.value || 0);
      const subtotal = cantidad * precio;

      if (subtotalField) {
        subtotalField.textContent = `$${subtotal.toFixed(2)}`;
      }

      total += subtotal;
      if (cantidad > 0) cantidadItems += 1;
    });

    document.getElementById('total-venta').textContent = `$${total.toFixed(2)}`;
    document.getElementById('cantidad-items').textContent = cantidadItems;
  }

  function inicializarEventosFila(fila) {
    const productoSelect = fila.querySelector('.producto');
    const cantidadInput = fila.querySelector('.cantidad');
    const precioInput = fila.querySelector('.precio-unitario');

    if (productoSelect) {
      productoSelect.addEventListener('change', function () {
        const productoId = this.value;
        const precio = precios[productoId];
        const stock = stocks[productoId];

        if (precio !== undefined) {
          precioInput.value = precio.toFixed(2);
        } else {
          precioInput.value = '';
          alert("⚠️ Este producto no tiene precio definido.");
        }

        if (stock !== undefined) {
          cantidadInput.max = stock;
        } else {
          cantidadInput.max = 0;
          alert("⚠️ Este producto no tiene stock disponible.");
        }

        actualizarTotales();
      });
    }

    if (cantidadInput) {
      cantidadInput.addEventListener('input', actualizarTotales);
    }

    const eliminarBtn = fila.querySelector('.eliminar-fila');
    if (eliminarBtn) {
      eliminarBtn.addEventListener('click', function () {
        fila.remove();
        actualizarTotales();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.item-venta').forEach(inicializarEventosFila);
    actualizarTotales();

    document.getElementById('agregar-fila').addEventListener('click', function () {
      const tabla = document.getElementById('tabla-items').querySelector('tbody');
      const ultimaFila = tabla.querySelector('.item-venta:last-child');
      const nuevaFila = ultimaFila.cloneNode(true);

      nuevaFila.querySelector('.producto').selectedIndex = 0;
      nuevaFila.querySelector('.cantidad').value = '';
      nuevaFila.querySelector('.precio-unitario').value = '';
      nuevaFila.querySelector('.subtotal').textContent = '$0.00';

      tabla.appendChild(nuevaFila);
      inicializarEventosFila(nuevaFila);
    });

    const medioPago = document.getElementById('id_medio_pago');
    const datosTarjeta = document.getElementById('datos-tarjeta');
    const qrPago = document.getElementById('qr-pago');

    function toggleMedioPago() {
      const valor = medioPago.value.toLowerCase();
      datosTarjeta.style.display = 'none';
      qrPago.style.display = 'none';

      if (valor === 'credito' || valor === 'debito') {
        datosTarjeta.style.display = 'block';
      } else if (valor === 'qr') {
        qrPago.style.display = 'block';
      }
    }

    if (medioPago) {
      medioPago.addEventListener('change', toggleMedioPago);
      toggleMedioPago();
    }
  });
</script>
{% endblock %}
